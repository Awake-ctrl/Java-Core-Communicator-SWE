name: Deploy Java project to Azure Function App

on:
  [push]

env:
  AZURE_FUNCTIONAPP_NAME: 'cloud-function-app'          # Function App name on Azure
  POM_XML_DIRECTORY: 'module-cloud'                     # Directory containing pom.xml
  JAVA_VERSION: '17'                                   # Java version to use

jobs:
  build-and-deploy:
    runs-on: windows-latest
    environment: dev

    steps:
      # Step 1: Checkout the repository
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      # Step 2: Setup Java SDK
      - name: Setup Java SDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: 'Create .env file for local Dotenv access'
        shell: pwsh
        run: |
          $env_content = @"
          COSMOS_ENDPOINT=${{ secrets.COSMOS_ENDPOINT }}
          COSMOS_KEY=${{ secrets.COSMOS_KEY }}
          COSMOS_DATABASE=${{ secrets.COSMOS_DATABASE }}
          CLOUD_BASE_URL=${{ secrets.CLOUD_BASE_URL }}
          "@
          $env_content | Out-File -FilePath './${{ env.POM_XML_DIRECTORY }}/.env' -Encoding utf8

      # Step 3: Build and package the project using Maven
      - name: 'Restore and Build with Maven'
        shell: pwsh
        run: |
          pushd './${{ env.POM_XML_DIRECTORY }}'
          mvn clean package
          popd

      # Step 4: Deploy the built project to Azure Function App
      # The package directory includes compiled function apps from:
      # module-cloud/src/main/java/functionapp/
      - name: 'Deploy to Azure Function App'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: '${{ env.POM_XML_DIRECTORY }}/target/azure-functions/${{ env.AZURE_FUNCTIONAPP_NAME }}'
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          respect-pom-xml: true
          arguments: |
            -DCOSMOS_ENDPOINT="${{ secrets.COSMOS_ENDPOINT }}" 
            -DCOSMOS_KEY="${{ secrets.COSMOS_KEY }}" 
            -DCOSMOS_DATABASE="${{ secrets.COSMOS_DATABASE }}"
            -DCLOUD_BASE_URL="${{ secrets.CLOUD_BASE_URL }}"
